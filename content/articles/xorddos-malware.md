---
title: Un malware, un cochon et un APT chinois
author: Eban
category: informatics
date: July 9, 2022
description: Par un heureux hasard, un fichier nommÃ© libudev.so, apparemment malveillant, est apparu dans notre dossier TÃ©lÃ©chargements, nous avons donc voulu en savoir plus. Entre reverse engineering, analyse rÃ©seau et OSINT, câ€™est cette quÃªte dâ€™information qui nous mÃ¨nera Ã  dÃ©couvrir un mystÃ©rieux pirate, vouant une adoration Ã  ses cochons, que nous allons relater dans cet article. Notre premier rÃ©flexe Ã  la vue de ce supposÃ© malware est de le scanner dans un logiciel antivirus (VirusTotal). Le rÃ©sultat est sans appel, de nombreux Ã©diteurs d'antivirus dÃ©tectent ce malware et le nomment, "XorDDoS".
highlighted: Yes
published: Yes
slug: xorddos-malware
initialPublisher: I Learned
initialLink: https://blog.ilearned.eu/xorddos.html
icon: tabler-pig
cover: https://uploads4.wikiart.org/images/niko-pirosmani/sow-with-piglets(1).jpg
coverDescription: Sow with piglets - Niko Pirosmani
---

Par un heureux hasard, un fichier nommÃ©Â `libudev.so`, apparemment malveillant, est apparu dans notre dossier TÃ©lÃ©chargements, nous avons donc voulu en savoir plus. Entre reverse engineering, analyse rÃ©seau et OSINT, câ€™est cette quÃªte dâ€™information qui nous mÃ¨nera Ã  dÃ©couvrir un mystÃ©rieux pirate, vouant une adoration Ã  ses cochons, que nous allons relater dans cet article.

Le sample analysÃ© tout au long de cet article est disponibleÂ [ici](https://bazaar.abuse.ch/sample/8642022960d919321ccfcfb0a0cd631db0e5dac3e75014fc0c4cc6ff413c72c5/).

*Disclaimer : I Learned ne saurait en aucun cas Ãªtre responsable de tout dommage engendrÃ© par la manipulation du fichier prÃ©sent ci-dessus, nous rappellons en outre que la distribution de malware Ã  des fins malveillantes est illÃ©gale. En outre, l'attribution d'un malware Ã  un acteur malveillant est un processus pÃ©rilleux, l'analyse qui suit est donc Ã  lire en gardant en tÃªte qu'il ne s'agit que de suppositions.*

Lâ€™image ci-dessous est une cartographie des informations rÃ©coltÃ©es dans cette enquÃªte, elle a Ã©tÃ© faite surÂ [Maltego](https://www.maltego.com/), nous l'utiliserons tout au long de cet article !

![maltego-global-view.webp](xorddos-malware/maltego-global-view.webp)

# ğŸ‘€ PremiÃ¨res analyses

Notre premier rÃ©flexe Ã  la vue de ce supposÃ© malware est de leÂ [scanner dans un logiciel antivirus (VirusTotal)](https://www.virustotal.com/gui/file/8642022960d919321ccfcfb0a0cd631db0e5dac3e75014fc0c4cc6ff413c72c5/detection). Le rÃ©sultat est sans appel, de nombreux Ã©diteurs d'antivirus dÃ©tectent ce malware et le nomment, "XorDDoS".

![virustotal.webp](xorddos-malware/virustotal.webp)

AprÃ¨s plusieurs recherches on peut observer que ce malware est en fait une version d'un logiciel malveillant trÃ¨s connu dÃ©couvert en 2014 par le groupe de rechercheÂ `MalwareMustDie`. Ce malware a mÃªme fait l'objet d'[un article de Microsoft](https://www.microsoft.com/security/blog/2022/05/19/rise-in-xorddos-a-deeper-look-at-the-stealthy-ddos-malware-targeting-linux-devices/), nÃ©anmoins, le virus analysÃ© par la sociÃ©tÃ© Ã©ditrice de Windows n'est pas la mÃªme version que celle que nous analysons dans cet article.

On peut aussi remarquer que le binaire a Ã©tÃ© compilÃ© de maniÃ¨re statique, c'est-Ã -dire en incluant toutes les librairies dont il dÃ©pend, par GCC 4.1.2 sur une machine Red Hat. La structure des fichiers sources du binaire est :

```
- autorun.c
- crc32.c
- encrypt.c
- execpacket.c
- buildnet.c
- hide.c
- http.c
- kill.c
- main.c
- proc.c
- socket.c
- tcp.c
- thread.c
- findip.c
- dns.c

```

Avec cette seule information, on peut dÃ©jÃ  observer certains fichiers intÃ©ressants, commeÂ `encrypt.c`Â ouÂ `hide.c`Â .

# ğŸ¦  L'infection

Le principal vecteur d'infection utilisÃ© par ce malware est leÂ [bruteforce](https://fr.wikipedia.org/wiki/Attaque_par_force_brute)Â de serveur SSH, d'oÃ¹ l'importance d'utiliser de privilÃ©giÃ© des clÃ©s cryptographiques, avec des algorithmes modernes (commeÂ [EdDSA](https://fr.wikipedia.org/wiki/EdDSA)), au lieu du traditionnel mot de passe.

Lors de la premiÃ¨re infection, le malware va faire en sorte d'assurer sa persistance, pour ce faire, il va en premier lieu crÃ©er le fichierÂ `/etc/cron.hourly/gcc.sh`, celui-ci contient un script qui va simplement dÃ©marrer toutes les interfaces rÃ©seau, se copier dans un autre endroit et se lancer. Le fait que ce script soit prÃ©sent dans le dossierÂ `/etc/cron.hourly`Â Ã  son importance, les scripts prÃ©sents dans ce dossier sont lancÃ© automatiquement par le systÃ¨me toutes les heures.

```
#!/bin/sh
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:/usr/X11R6/
for i in `cat /proc/net/dev|grep :|awk -F: {'print $1'}`;
  do ifconfig $i up
done # DÃ©marre toutes les interfaces rÃ©seau
cp /lib/libudev.so /lib/libudev.so.6
/lib/libudev.so.6
```

Le nommage du script enÂ `gcc.sh`Â est sÃ»rement fait pour se faire passer pour le compilateur bien connuÂ `gcc`Â et donc ne pas paraitre suspect.

Une fois ce script cron crÃ©Ã©, le malware va aussi crÃ©er un fichier dansÂ `/etc/init.d`, ce dossier contient des fichiers de services systemd, runit ou openrc sous forme de script shell (ğŸ¤®). Le malware va donc crÃ©er dans ce dossier un fichier contenant le code suivant :

```
#!/bin/sh
# chkconfig: 12345 90 90
# description: tlvgyjdotz
case $1 in
start)
	/usr/bin/tlvgyjdotz
	;;
stop)
	;;
*)
	/usr/bin/tlvgyjdotz
	;;
esac
```

On voit que ce simple script shell lance un binaire dansÂ `/usr/bin`, c'est en fait le mÃªme binaire que celui de notre malware initial (`libudev.so`) mais qui est simplement copiÃ© avec un nom alÃ©atoire, sÃ»rement pour Ã©chapper Ã  certains systÃ¨mes de protection.

Ces deux moyens d'assurer la persistance du malware sont gÃ©rÃ©s par les fonctionsÂ `InstallSys`Â etÂ `add_service`.

# ğŸ—¨ï¸ Communication avec le C2

Une fois que le malware est installÃ© avec succÃ¨s, il va commencer la communication avec le C2 â€“ C2, pour Command&Control, c'est le nom du/des serveur-s qui donnent des ordres aux machines infectÃ©es. Toute la communication avec l'extÃ©rieur se fait via une fonction nommÃ©eÂ `exec_packet`. Cette fonction permet notamment au binaire de se mettre Ã  jour, mais aussi de tÃ©lÃ©charger d'autres binaires et de les lancer. Via cette fonction, le malware est aussi capable d'envoyer un hash md5 de son processus et de recevoir l'ordre de tuer certains processus. Lors de la premiÃ¨re communication avec le C2, on a pu dÃ©terminer que plusieurs informations concernant la machine sont envoyÃ©es, dont notamment des statistiques sur la RAM, le CPU ou encore la vitesse de la connexion.

Enfin, cette fonction permet aussi de crÃ©er un grand nombre de threads dans lesquels est exÃ©cutÃ©e une fonction qui envoie des paquets TCP SYN, DNS ou TCP ACK, au vu du comportement de cette fonction, on peut supputer que ce serait elle qui serait en charge de lancer un DDoS vers une cible, les paquetsÂ [SYN](https://www.cloudflare.com/learning/ddos/syn-flood-ddos-attack/),Â [ACK](https://www.cloudflare.com/learning/ddos/what-is-an-ack-flood/)Â etÂ [DNS](https://www.cloudflare.com/learning/ddos/dns-amplification-ddos-attack/)Â Ã©tant notamment trÃ¨s utilisÃ©s pour mener ce genre d'actions malveillantes.

![malware-function-schema.webp](xorddos-malware/malware-function-schema.webp)

Aussi, on peut remarquer qu'une grande partie des communications sont chiffrÃ©es au moyen de l'algorithme XOR, les clÃ©s (`BB2FA36AAA9541F0`) Ã©tant prÃ©sentes en clair dans le code (ğŸ¤¦) il est trivial de dÃ©chiffrer ces donnÃ©es, celles-ci Ã©tant principalement des noms de domaine qui rÃ©vÃ¨leront leur utilitÃ© dans la prochaine partie.

C'est l'utilisation intensive de XOR qui donne d'ailleurs Ã  ce malware son nom, XorDDoS.

# ğŸŒ Exploration de l'infrastructure du botnet

En explorant les trames rÃ©seaux et Ã  la lecture du code dÃ©compilÃ©, nous avons rapidement pu identifier 4 domaines liÃ©s au malware. Deux d'entre eux contiennent la liste des potentielles C2. Un autre domaine semble liÃ© une liste de victimes, le 4áµ‰ domaine est lui inutilisÃ©.

Nous avons pu trouver trois dÃ©nominateurs communs pour les serveurs qui semblent Ãªtre les C2

- Ce sont des machines sous Windows Server 2012
- Les IPs de ces serveurs appartiennent Ã  l'hÃ©bergeur OVH, sous 2 organisations diffÃ©rentes.
- Ces deux organisations sont liÃ©es par un mail commun dans leur whois,Â `admin@66[.]to`.

![hack520-maltego.webp](xorddos-malware/hack520-maltego.webp)

Sur le nom de domaineÂ `66[.]to`, directement liÃ© Ã  l'adresse mail, on peut trouver, tout d'abord, ce site avec cette magnifique image de cochon, elle aura son importance plus tard. Le site nous renvois par ailleurs vers le sous-domaineÂ `secure[.]66[.]to`.

![66-to-capture.webp](xorddos-malware/66-to-capture.webp)

En se rendant surÂ `secure[.]66[.]to`Â on se retrouve sur le site d'un hÃ©bergeur un peu suspect.

![secure-66-to-capture.webp](xorddos-malware/secure-66-to-capture.webp)

(Les pages ont Ã©tÃ© traduites en anglais pour les besoins de l'article, elles Ã©taient initialement en chinois.)

L'hÃ©bergeur en question est, selon les informations que nous avons pu trouverÂ¹, liÃ© Ã  un pirate rÃ©pondant au pseudo de Hack520 (nous y reviendrons).

En analysant les requÃªtes DNS faites par le binaire, nous avons pu remarquer le domaineÂ `a1.evil`*, ces requÃªtes renvoyant une liste d'IPs ne semblant n'avoir aucun lien entre elles. De plus, les IPs liÃ©es Ã  ce nom de domaine changent de temps en temps, il semblerait que ces IPs sont seraient celles des machines compromises par le virus.

# ğŸ· DÃ©couverte de notre amateur de cochon

Comme citÃ© plus haut, nous avons rÃ©ussi Ã  lier le botnet Ã  un individu rÃ©pondant au pseudo hack520.

C'est l'image de cochon que nous avons pu voir tout Ã  l'heure qui nous a permise de remonter jusqu'Ã  lui. La recherche d'image inversÃ©e de Baidu, nous a permise de remonter Ã  un article de TrendMicro Ã  propos de cet individu. La recherche inversÃ©e nous a aussi permise de retrouver certains de ses rÃ©seaux sociaux. Nous avons d'abord pu trouver son blog (`zhu[.]vn`), qui contenait des liens vers son compte twitter (`hack520_est`), nous avons aussi pu retrouver le Github (`Kwan9`) lui aussi grÃ¢ce Ã  l'image de cochon qui se trouve Ãªtre la photo de profil. Par ailleurs, les deux cochons que vous pouvez retrouver ci-dessous rÃ©pondent aux doux noms de LouLou (å™œå™œ) et Mouchoutoutou (æ¯è±¬å˜Ÿå˜Ÿ).

![loulou.webp](xorddos-malware/loulou.webp)

![moutchoutoutou.webp](xorddos-malware/moutchoutoutou.webp)

Son compte github montre un certain attrait pour les mineurs de cryptomonnaie. Ã€ en croire ses commits, il possÃ¨derait l'adresse mailÂ `kwanleo@126.com`. On peut aussi via github savoir que son ordinateur est dans la timezone Asia/Shanghai, elle permet, avec diverses autres informations que nous avons, de faire penser qu'il se situerait Ã  Hong Kong. Un autre Ã©lÃ©ment qui tend Ã  prouver sa prÃ©sence sur Hong Kong est cetteÂ [photo](https://twitter.com/hack520_est/status/697290929107898368)Â sur son twitter qui nous montre le tÃ©lÃ©phÃ©rique deÂ [Ngong Ping](https://en.wikipedia.org/wiki/Ngong_Ping). Un post sur son github nous permet aussi de voir qu'il utilise windows.

Nous avons trouvÃ© certains de ses autres rÃ©seaux sociaux, mais il ne nous semblait rien apporter, c'est pourquoi nous ne les avons pas mis ici.

Via l'article de trendmicro, on apprend par ailleurs qu'il est potentiellement membre deÂ [Winnti Group](https://malpedia.caad.fkie.fraunhofer.de/actor/axiom), un collectif proche d'[APT](https://fr.wikipedia.org/wiki/Advanced_Persistent_Threat)Â chinois (41 et 17).

# ğŸ“‘ Conclusion

Pour rÃ©sumer, dâ€™aprÃ¨s nos analyses, ce malware relativement peu sophistiquÃ© serait utilisÃ© pour former un rÃ©seau de botnet. Un botnet est un rÃ©seau de machines rÃ©pondant un ordre dâ€™un serveur central (C2), utilisÃ©es pour faire des attaques DDoS â€” Distributed Denial of Service. Nous avons par ailleurs rÃ©ussi Ã  identifier certaines victimes prÃ©sumÃ©es prÃ©sentes dans ce rÃ©seau de botnet. Il s'avÃ¨re que ce logiciel malveillant est dÃ©jÃ  relativement connu et nommÃ© XorDDos. Celui-ci est d'ailleurs dÃ©tectÃ© par de nombreux antivirus, incluant le logiciel libreÂ [ClamAV](https://www.clamav.net/). Si vous souhaitez vous protÃ©ger de menaces similaires, il peut Ãªtre intÃ©ressant de vous renseigner sur l'utilisation de logiciels antivirus sur vos serveurs !

*Les adresses et pseudonymes ont Ã©tÃ© modifiÃ©s

- [1]Â [Examining a Possible Member of the Winnti Group](https://www.trendmicro.com/en_us/research/17/d/pigs-malware-examining-possible-member-winnti-group.html)
